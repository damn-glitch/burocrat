generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

model company {
  id                   Int                    @id @default(autoincrement())
  name                 String                 @db.VarChar(100)
  code                 String?                @unique @db.VarChar(50)
  color                String?                @db.VarChar(20)
  country_id           Int?
  industry_id          Int?
  legal_form_id        Int?
  description          String?
  owner_id             Int?
  is_active            Boolean?               @default(false)
  logo                 String?                @db.VarChar(500)
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  country              country?               @relation(fields: [country_id], references: [id], onUpdate: NoAction)
  industry             industry?              @relation(fields: [industry_id], references: [id], onUpdate: NoAction)
  legal_form           legal_form?            @relation(fields: [legal_form_id], references: [id], onUpdate: NoAction)
  users                users?                 @relation(fields: [owner_id], references: [id], onUpdate: NoAction)
  document             document[]
  employee_company_rel employee_company_rel[]
  folder               folder[]
  invitation           invitation[]
  project              project[]
  generated_document   generated_document[]
  ocr_result           ocr_result[]

  @@index([owner_id, created_at(sort: Desc)])
  @@schema("public")
}

model country {
  id         Int       @id @default(autoincrement())
  name       String    @db.VarChar(100)
  code       String?   @unique @db.VarChar(10)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  company    company[]

  @@schema("public")
}

model document {
  id                  Int                   @id @default(autoincrement())
  title               String                @db.VarChar(100)
  content             String?
  created_by          Int?
  folder_id           Int?
  company_id          Int?
  attachments         Json?
  created_at          DateTime?             @default(now()) @db.Timestamp(6)
  updated_at          DateTime?             @default(now()) @db.Timestamp(6)
  company             company?              @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users               users?                @relation(fields: [created_by], references: [id], onUpdate: NoAction)
  folder              folder?               @relation(fields: [folder_id], references: [id], onUpdate: NoAction)
  document_attachment document_attachment[]

  @@schema("public")
}

model document_attachment {
  id          Int       @id @default(autoincrement())
  document_id Int
  uri         String    @db.VarChar(500)
  meta        Json?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  document    document  @relation(fields: [document_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([document_id])
  @@schema("public")
}

model employee_company_rel {
  id          Int       @id @default(autoincrement())
  user_id     Int
  company_id  Int
  position_id Int?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  company     company   @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  position    position? @relation(fields: [position_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, company_id])
  @@index([company_id, created_at(sort: Desc)])
  @@index([user_id])
  @@schema("public")
}

model employee_project_rel {
  id          Int       @id @default(autoincrement())
  user_id     Int
  project_id  Int
  position_id Int?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  position    position? @relation(fields: [position_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  project     project   @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, project_id])
  @@index([project_id, created_at(sort: Desc)])
  @@index([user_id])
  @@schema("public")
}

model folder {
  id           Int        @id @default(autoincrement())
  name         String     @db.VarChar(100)
  parent_id    Int?
  company_id   Int
  created_at   DateTime?  @default(now()) @db.Timestamp(6)
  document     document[]
  company      company    @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  folder       folder?    @relation("folderTofolder", fields: [parent_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  other_folder folder[]   @relation("folderTofolder")

  @@unique([name, parent_id, company_id])
  @@index([company_id, parent_id])
  @@schema("public")
}

model industry {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  code        String?   @unique @db.VarChar(50)
  description String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  company     company[]

  @@schema("public")
}

model invitation {
  id                                 Int       @id @default(autoincrement())
  email                              String    @db.VarChar(100)
  token                              String    @unique @db.VarChar(255)
  position_id                        Int?
  user_id                            Int?
  company_id                         Int?
  invited_by                         Int?
  status                             String?   @default("pending") @db.VarChar(50)
  created_at                         DateTime? @default(now()) @db.Timestamp(6)
  expires_at                         DateTime? @db.Timestamp(6)
  project_id                         Int?
  company                            company?  @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_invitation_invited_byTousers users?    @relation("invitation_invited_byTousers", fields: [invited_by], references: [id], onUpdate: NoAction)
  position                           position? @relation(fields: [position_id], references: [id], onUpdate: NoAction)
  project                            project?  @relation(fields: [project_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "invitation_project_id_fk")
  users_invitation_user_idTousers    users?    @relation("invitation_user_idTousers", fields: [user_id], references: [id], onUpdate: NoAction)

  @@schema("public")
}

model legal_form {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  code        String?   @unique @db.VarChar(50)
  description String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  company     company[]

  @@schema("public")
}

model notification {
  id                Int                 @id @default(autoincrement())
  title             String?             @db.VarChar(100)
  description       String?
  preview_image     String?             @db.VarChar(500)
  data              Json?
  created_at        DateTime?           @default(now()) @db.Timestamp(6)
  user_notification user_notification[]

  @@schema("public")
}

model otp {
  id         Int       @id @default(autoincrement())
  user_id    Int
  code       String    @db.VarChar(10)
  type       String    @db.VarChar(20)
  action     String    @db.VarChar(50)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  expires_at DateTime? @db.Timestamp(6)
  is_used    Boolean?  @default(false)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, action, type, is_used, expires_at])
  @@schema("public")
}

model permissions {
  id                  Int                   @id @default(autoincrement())
  name                String                @unique @db.VarChar(100)
  description         String?               @db.VarChar(255)
  code                String?               @db.VarChar(50)
  created_at          DateTime?             @default(now()) @db.Timestamp(6)
  role_permission_rel role_permission_rel[]

  @@schema("public")
}

model position {
  id                   Int                    @id @default(autoincrement())
  name                 String                 @db.VarChar(100)
  code                 String?                @unique @db.VarChar(50)
  description          String?
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  employee_company_rel employee_company_rel[]
  employee_project_rel employee_project_rel[]
  invitation           invitation[]

  @@schema("public")
}

model project {
  id                   Int                    @id @default(autoincrement())
  name                 String                 @db.VarChar(100)
  code                 String?                @unique @db.VarChar(50)
  description          String?
  company_id           Int
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  color                String?                @db.VarChar(30)
  owner_id             Int?
  is_active            Boolean?
  employee_project_rel employee_project_rel[]
  invitation           invitation[]
  company              company                @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users                users?                 @relation(fields: [owner_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "project_users_id_fk")
  task                 task[]
  task_log             task_log[]

  @@index([company_id, created_at(sort: Desc)])
  @@schema("public")
}

model refresh_token {
  id         Int       @id @default(autoincrement())
  user_id    Int
  token      String    @unique @db.VarChar(255)
  user_agent String?   @db.VarChar(255)
  ip         String?   @db.VarChar(64)
  expires_at DateTime  @db.Timestamptz(6)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id])
  @@schema("public")
}

model role_permission_rel {
  id            Int         @id @default(autoincrement())
  role_id       Int
  permission_id Int
  permissions   permissions @relation(fields: [permission_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  roles         roles       @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([role_id, permission_id])
  @@schema("public")
}

model roles {
  id                  Int                   @id @default(autoincrement())
  name                String                @unique @db.VarChar(50)
  description         String?               @db.VarChar(255)
  code                String?               @unique(map: "roles_code_unique") @db.VarChar(50)
  created_at          DateTime?             @default(now()) @db.Timestamp(6)
  role_permission_rel role_permission_rel[]
  user_role_rel       user_role_rel[]

  @@schema("public")
}

model settings {
  id            Int             @id @default(autoincrement())
  slug          String          @unique @db.VarChar(100)
  type          String?         @db.VarChar(50)
  name          String          @db.VarChar(100)
  user_settings user_settings[]

  @@schema("public")
}

model task {
  id                            Int       @id @default(autoincrement())
  name                          String    @db.VarChar(100)
  path                          String    @db.VarChar(500)
  description                   String?
  status                        String    @db.VarChar(50)
  priority                      String    @db.VarChar(50)
  due_date                      DateTime? @db.Timestamp(6)
  project_id                    Int?
  assignee_id                   Int?
  manager_id                    Int?
  created_at                    DateTime? @default(now()) @db.Timestamp(6)
  updated_at                    DateTime? @default(now()) @db.Timestamp(6)
  users_task_assignee_idTousers users?    @relation("task_assignee_idTousers", fields: [assignee_id], references: [id], onUpdate: NoAction)
  users_task_manager_idTousers  users?    @relation("task_manager_idTousers", fields: [manager_id], references: [id], onUpdate: NoAction)
  project                       project?  @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([project_id, status, priority, due_date])
  @@schema("public")
}

model task_log {
  id                                Int       @id @default(autoincrement())
  task_id                           Int
  name                              String    @db.VarChar(100)
  path                              String    @db.VarChar(500)
  description                       String?
  status                            String    @db.VarChar(50)
  priority                          String    @db.VarChar(50)
  due_date                          DateTime? @db.Timestamp(6)
  project_id                        Int?
  assignee_id                       Int?
  manager_id                        Int?
  created_at                        DateTime? @default(now()) @db.Timestamp(6)
  updated_at                        DateTime? @default(now()) @db.Timestamp(6)
  users_task_log_assignee_idTousers users?    @relation("task_log_assignee_idTousers", fields: [assignee_id], references: [id], onUpdate: NoAction)
  users_task_log_manager_idTousers  users?    @relation("task_log_manager_idTousers", fields: [manager_id], references: [id], onUpdate: NoAction)
  project                           project?  @relation(fields: [project_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("public")
}

model user_notification {
  id              Int          @id @default(autoincrement())
  user_id         Int
  notification_id Int
  is_read         Boolean?     @default(false)
  read_at         DateTime?    @db.Timestamp(6)
  created_at      DateTime?    @default(now()) @db.Timestamp(6)
  notification    notification @relation(fields: [notification_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users           users        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, is_read])
  @@schema("public")
}

model user_role_rel {
  id         Int       @id @default(autoincrement())
  user_id    Int
  role_id    Int
  created_at DateTime? @default(now()) @db.Timestamp(6)
  roles      roles     @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, role_id])
  @@schema("public")
}

model user_settings {
  id         Int      @id @default(autoincrement())
  user_id    Int
  setting_id Int
  value      String?
  settings   settings @relation(fields: [setting_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, setting_id])
  @@schema("public")
}

model users {
  id                                      Int                    @id @default(autoincrement())
  firstname                               String?                @db.VarChar(50)
  lastname                                String?                @db.VarChar(50)
  middlename                              String?                @db.VarChar(50)
  username                                String?                @unique @db.VarChar(50)
  avatar                                  String?                @db.VarChar(500)
  phone                                   String?                @unique @db.VarChar(20)
  email                                   String?                @unique @db.VarChar(100)
  password_hash                           String                 @db.VarChar(255)
  created_at                              DateTime?              @default(now()) @db.Timestamp(6)
  login_attempts                          Int?                   @default(0)
  is_active                               Boolean?               @default(true)
  company                                 company[]
  document                                document[]
  employee_company_rel                    employee_company_rel[]
  employee_project_rel                    employee_project_rel[]
  invitation_invitation_invited_byTousers invitation[]           @relation("invitation_invited_byTousers")
  invitation_invitation_user_idTousers    invitation[]           @relation("invitation_user_idTousers")
  otp                                     otp[]
  project                                 project[]
  refresh_token                           refresh_token[]
  task_task_assignee_idTousers            task[]                 @relation("task_assignee_idTousers")
  task_task_manager_idTousers             task[]                 @relation("task_manager_idTousers")
  task_log_task_log_assignee_idTousers    task_log[]             @relation("task_log_assignee_idTousers")
  task_log_task_log_manager_idTousers     task_log[]             @relation("task_log_manager_idTousers")
  user_notification                       user_notification[]
  user_role_rel                           user_role_rel[]
  user_settings                           user_settings[]
  generated_document                      generated_document[]
  ocr_result                              ocr_result[]
  ai_document_analysis                    ai_document_analysis[]

  @@index([created_at(sort: Desc)])
  @@schema("public")
}

// ==================== OCR & Document Generation ====================

// Сгенерированные документы (счета, накладные, акты)
model generated_document {
  id            Int       @id @default(autoincrement())
  type          String    @db.VarChar(50) // invoice, waybill, completion_act
  number        String    @db.VarChar(100) // Номер документа
  status        String    @default("draft") @db.VarChar(50) // draft, signed, sent, paid
  data          Json      // Все данные документа (продавец, покупатель, товары и т.д.)
  pdf_url       String?   @db.VarChar(500) // Ссылка на сгенерированный PDF
  total_amount  Decimal?  @db.Decimal(15, 2)
  currency      String    @default("RUB") @db.VarChar(10)
  company_id    Int?
  created_by    Int?
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @default(now()) @db.Timestamp(6)
  company       company?  @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users         users?    @relation(fields: [created_by], references: [id], onUpdate: NoAction)

  @@index([company_id, type, created_at(sort: Desc)])
  @@index([number])
  @@schema("public")
}

// Результаты OCR распознавания
model ocr_result {
  id               Int       @id @default(autoincrement())
  original_file    String    @db.VarChar(500) // Путь к оригинальному файлу
  recognized_text  String?   // Распознанный текст
  confidence       Decimal?  @db.Decimal(5, 2) // Уверенность распознавания (0-100%)
  language         String?   @db.VarChar(10) // Язык документа
  metadata         Json?     // Дополнительные данные (размеры, формат и т.д.)
  processing_time  Int?      // Время обработки в мс
  status           String    @default("pending") @db.VarChar(50) // pending, processing, completed, failed
  error_message    String?
  company_id       Int?
  created_by       Int?
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  company          company?  @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users            users?    @relation(fields: [created_by], references: [id], onUpdate: NoAction)
  ai_analysis      ai_document_analysis[]

  @@index([company_id, created_at(sort: Desc)])
  @@index([status])
  @@schema("public")
}

// Результаты анализа документов ИИ
model ai_document_analysis {
  id               Int        @id @default(autoincrement())
  ocr_result_id    Int?
  document_type    String?    @db.VarChar(100) // Тип распознанного документа
  extracted_data   Json?      // Извлечённые структурированные данные
  summary          String?    // Краткое описание документа
  entities         Json?      // Извлечённые сущности (даты, суммы, организации)
  confidence       Decimal?   @db.Decimal(5, 2)
  model_used       String?    @db.VarChar(100) // Модель ИИ
  tokens_used      Int?       // Использовано токенов
  processing_time  Int?       // Время обработки в мс
  status           String     @default("pending") @db.VarChar(50)
  error_message    String?
  created_by       Int?
  created_at       DateTime?  @default(now()) @db.Timestamp(6)
  ocr_result       ocr_result? @relation(fields: [ocr_result_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users            users?     @relation(fields: [created_by], references: [id], onUpdate: NoAction)

  @@index([ocr_result_id])
  @@index([document_type])
  @@schema("public")
}
